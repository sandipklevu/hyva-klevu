(function(klevu){if(klevu.recs&&klevu.recs.base){klevu.extend(true,klevu.dom.helpers,{escapeHTML:function(string){if(string&&string.length){var entityMap={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'};return String(string).replace(/[&<>"'`=\/]/g,function(s){return entityMap[s];});}else{return string;}},cleanUpProductImage:function(element){var elementSrc=element.getAttribute("src");if(elementSrc&&elementSrc.length){var kuThumbnailImage="";if(typeof klevu.search.modules.kmcInputs.base.getKMCUserOptionsNoImageUrl==="function"){kuThumbnailImage=klevu.search.modules.kmcInputs.base.getKMCUserOptionsNoImageUrl();}else{kuThumbnailImage="https://js.klevu.com/klevu-js-v1/img-1-1/place-holder.jpg";}
        var isKlevuPlaceholderImage=(element.src.indexOf(kuThumbnailImage)>-1);if(isKlevuPlaceholderImage){element.src="";element.onerror="";return;}
        var isPubAdded=(element.src.indexOf("/pub")>-1);if(isPubAdded){element.src=element.src.replace("/pub","");element.onerror=function(){element.src=kuThumbnailImage;element.onerror="";};}else{var isOnlyMediaAdded=(element.src.indexOf("/media")>-1);var isNeedToChangeAppended=(element.src.indexOf("needtochange/")>-1);var originValue=element.getAttribute("origin");if(isNeedToChangeAppended){element.src=element.src.replace("needtochange/","");}else if(isOnlyMediaAdded){element.src=element.src.replace("/media","/pub/media");}else if(originValue){element.src=originValue.replace("needtochange/","pub/");element.onerror=function(){element.src=kuThumbnailImage;element.onerror="";};}}}else{var kuThumbnailImage="";if(typeof klevu.search.modules.kmcInputs.base.getKMCUserOptionsNoImageUrl==="function"){kuThumbnailImage=klevu.search.modules.kmcInputs.base.getKMCUserOptionsNoImageUrl();}else{kuThumbnailImage="https://js.klevu.com/klevu-js-v1/img-1-1/place-holder.jpg";}
        element.src=kuThumbnailImage;element.onerror="";}},readCookie:function(cookieName){var dataProtection=(klevu.isFunction(klevu.support.isActive))?klevu.support.isActive("dataProtection"):!klevu.isUndefined(klevu.support.dataProtection);if(cookieName===klevu.getGlobalSetting("constants.COOKIE_KLEVU_RCP")&&dataProtection){if(klevu.dataProtection.getUseConsent()&&!klevu.dataProtection.dataCanBeTracked()){return"";}}
        var theCookie=" "+document.cookie,start=theCookie.indexOf(" "+cookieName+"="),end=theCookie.indexOf(";",start+1);if(start===-1){start=theCookie.indexOf(";"+cookieName+"=");}
        if(start===-1||cookieName===""){return"";}
        end=theCookie.indexOf(";",start+1);if(end===-1){end=theCookie.length;}
        return decodeURIComponent(theCookie.substring(start+cookieName.length+2,end));},addClickedProductToCookie:function(productId){var dataProtection=(klevu.isFunction(klevu.support.isActive))?klevu.support.isActive("dataProtection"):!klevu.isUndefined(klevu.support.dataProtection);if(dataProtection){if(klevu.dataProtection.getUseConsent()&&!klevu.dataProtection.dataCanBeTracked()){return false;}}
        var encodedProductId=window.btoa(productId),cookieValue=klevu.dom.helpers.readCookie(klevu.settings.constants.COOKIE_KLEVU_RCP),existingProductIds,updatedCookieValue=encodedProductId,cookieExpiry=new Date(),httpOnlyTag="undefined"!==typeof klevu_setHttpOnlyToCookies&&klevu_setHttpOnlyToCookies?"; HttpOnly":"";if(cookieValue&&cookieValue.trim()!==''){existingProductIds=cookieValue.split("#-#");if(existingProductIds.indexOf(encodedProductId)!==-1){existingProductIds.splice(existingProductIds.indexOf(encodedProductId),1);}else{if(existingProductIds.length>=20){existingProductIds.splice(-1,1);}}
            existingProductIds.splice(0,0,encodedProductId);updatedCookieValue=existingProductIds.join("#-#");}
        cookieExpiry.setTime(cookieExpiry.getTime()+(365*24*60*60*1000));document.cookie=klevu.settings.constants.COOKIE_KLEVU_RCP+"="+updatedCookieValue+";expires="+cookieExpiry.toUTCString()+";path=/"+";SameSite=None; Secure"+httpOnlyTag;}});klevu({storage:{recs:klevu.dictionary("analyticsEvents")},constants:{COOKIE_KLEVU_RCP:"",RECS_QUERY_ID:"klevuRECSItemList",RECS_PT_HOME:"HOME",RECS_PT_CATEGORY:"CATEGORY",RECS_PT_PRODUCT:"PRODUCT",RECS_PT_CHECKOUT:"CHECKOUT",RECS_LC_TRENDING:"TRENDING",RECS_LC_TRENDING_PERSONALIZED:"TRENDING_PERSONALIZED",RECS_LC_NEWEST_ARRIVALS:"NEWEST_ARRIVALS",RECS_LC_RECENTLY_VIEWED:"RECENTLY_VIEWED",RECS_LC_HAND_PICKED:"HAND_PICKED",RECS_LC_OTHER_ALSO_VIEWED:"OTHER_ALSO_VIEWED",RECS_LC_SIMILAR:"SIMILAR",RECS_LC_BOUGHT_TOGETHER:"BOUGHT_TOGETHER",RECS_LC_BOUGHT_TOGETHER_PDP:"BOUGHT_TOGETHER_PDP",RECS_LC_VISUALLY_SIMILAR:"VISUALLY_SIMILAR",RECS_LC_RECS_CUSTOM:"CUSTOM_LOGIC",RECS_RPT:"recsPageType:"}});klevu.setObjectPath(klevu.recs.base.getScope(),"chains.type.staticContent",klevu.chain({stopOnFalse:true}));klevu.setObjectPath(klevu.recs.base.getScope(),"chains.type.hideBanner",klevu.chain({stopOnFalse:true}));klevu.recs.base.getScope().chains.response.success.addBefore('executeSearchObjectPowerUp',{name:"checkForHideBanner",fire:function(data,scope){var action=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.action",false);if(action==="HIDE_RECOMMENDATION"){var chain=klevu.getObjectPath(scope.recsScope,"chains.type.hideBanner");if(!klevu.isUndefined(chain)&&chain.list().length!==0){chain.setScope(scope.recsElem);chain.setData(data);chain.fire();}
        return false;}}});klevu.recs.base.getScope().chains.response.success.addBefore('executeSearchObjectPowerUp',{name:"checkForStaticContent",fire:function(data,scope){var action=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.action",false);if(action==="STATIC_CONTENT"){var chain=klevu.getObjectPath(scope.recsScope,"chains.type.staticContent");if(!klevu.isUndefined(chain)&&chain.list().length!==0){chain.setScope(scope.recsElem);chain.setData(data);chain.fire();}
        return false;}}});klevu.recs.base.getScope().chains.response.success.move({name:"buildTheSearchObject",before:"executeSearchObjectPowerUp"});var RECS_BASE=klevu.recs.base;RECS_BASE.getScope().chains.search.control.add({name:"checkRecsAction",fire:function(data,scope){var recsAction=klevu.getObjectPath(scope.recsScope,"kmcData.search.recsAction");switch(recsAction){case"HIDE_RECOMMENDATION":return false;break;}}});RECS_BASE.getScope().chains.search.control.add({name:"validateRECSElementData",fire:function(data,scope){var recsKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.recsKey");if(!recsKey){console.info("RECS element id is missing.");return false;}
        var isEnabled=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.enabled");if(!isEnabled){console.info("["+recsKey+"] element is disabled.");return false;}
        var hasAnyError=false;var logic=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.logic");if(!logic){console.info("["+recsKey+"] RECS logic is missing.");hasAnyError=true;}
        var pageType=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.pageType");if(!pageType){console.info("["+recsKey+"] RECS page type is missing.");hasAnyError=true;}
        var maxProducts=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.maxProducts");if(typeof maxProducts==="undefined"||maxProducts===""){klevu.setObjectPath(scope.recsScope,"kmcData.metadata.maxProducts",12);}
        var productThreshold=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.productThreshold");if(typeof productThreshold==="undefined"||productThreshold===""){klevu.setObjectPath(scope.recsScope,"kmcData.metadata.productThreshold",4);}
        if(hasAnyError){return false;}
        scope.recsScope.searchObject.getScope().parentScope=scope.recsScope;}});RECS_BASE.getScope().chains.search.control.add({name:"addElementStylesToHead",fire:function(data,scope){var recsKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.recsKey");var elementStyles=klevu.getObjectPath(scope.recsScope,"kmcData.styles.base");if(recsKey){klevu.each(klevu.dom.find("#ku-recs-"+recsKey),function(key,existingElement){if(existingElement&&existingElement.parentNode){existingElement.parentNode.removeChild(existingElement);}});}
        klevu.dom.helpers.addElementToHead({content:elementStyles,type:"css",name:"ku-recs-"+recsKey});}});RECS_BASE.getScope().chains.search.control.add({name:"createStorageForRECS",fire:function(data,scope){var storage=klevu.getSetting(scope.recsScope.settings,"settings.storage");storage.recs.setStorage("local");storage.recs.mergeFromGlobal();storage.recs.mergeToGlobal();}});RECS_BASE.getScope().chains.search.control.add({name:"addSearchSettings",fire:function(data,scope){var inputKEY=klevu.getSetting(scope.recsScope,"settings.recs.apiKey",klevu.getGlobalSetting("recs.apiKey",klevu.getGlobalSetting("global.apiKey")));var searchBasePath=klevu.getObjectPath(scope.recsScope,"kmcData.search.basePath");var apiKeyForCookie=inputKEY.replace(/-/g,"_");klevu.setObjectPath(klevu.settings,"constants.COOKIE_KLEVU_RCP","klevu_rcp_"+apiKeyForCookie);var RECS_BOX=scope.recsScope.searchObject;klevu.setSetting(RECS_BOX.getScope().settings,"settings.search.apiKey",inputKEY);klevu.setSetting(RECS_BOX.getScope().settings,"settings.analytics.apiKey",inputKEY);klevu.setSetting(RECS_BOX.getScope().settings,"settings.search.minChars",1);klevu.setSetting(RECS_BOX.getScope().settings,"settings.url.search","https:"+"//"+searchBasePath);}});RECS_BASE.getScope().chains.search.control.add({name:"registerRECSTemplate",fire:function(data,scope){var RECS_BOX=scope.recsScope.searchObject;var templateString=klevu.getObjectPath(scope.recsScope,"kmcData.templates.base");RECS_BOX.getScope().template.setTemplate(templateString,"kuRECSTemplate",true);}});RECS_BASE.getScope().chains.search.control.add({name:"populateSearchQueryData",fire:function(data,scope){var RECS_BOX=scope.recsScope.searchObject;RECS_BOX.getScope().chains.request.build.add({name:"addSearchQuery",fire:function(data,scope){var searchPayload=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.search.payload");try{var searchQueryJSON=JSON.parse(searchPayload);var recordQueries=(searchQueryJSON&&searchQueryJSON.recordQueries)?searchQueryJSON.recordQueries:[];klevu.setObjectPath(data,"request.current.recordQueries",recordQueries);data.context.doSearch=true;}catch(error){console.error(error);}}});RECS_BOX.getScope().chains.request.build.add({name:"addStoredProductIdsV1",fire:function(data,scope){var maxProducts=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.maxProducts");var cookieValue=klevu.dom.helpers.readCookie(klevu.settings.constants.COOKIE_KLEVU_RCP);data.context.storedProductIds=[];if(cookieValue&&cookieValue.trim()!==''){var productIds=[];var storedProductIdList=cookieValue.split("#-#");storedProductIdList.forEach(function(productId){if(productIds.length<maxProducts){productIds.push(atob(productId));}});data.context.storedProductIds=productIds;}}});RECS_BOX.getScope().chains.request.build.add({name:"addTrendingProductsQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_TRENDING){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){if(pageType==klevu.settings.constants.RECS_PT_CATEGORY){var categoryName="";if(typeof klevu_page_meta!=="undefined"&&klevu_page_meta.categoryName){categoryName=klevu.dom.helpers.convertHtmlToText(klevu_page_meta.categoryName);}
                klevu.setObjectPath(query,"settings.query.categoryPath",categoryName);}}});}}});RECS_BOX.getScope().chains.request.build.add({name:"addTrendingProductsWithPersonalizationQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_TRENDING_PERSONALIZED){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){var recentObjectsList=[];var recentObjects=klevu.getObjectPath(query,"settings.context.recentObjects");if(recentObjects&&recentObjects.length){recentObjectsList=recentObjects;}
                var storedProductIds=data.context.storedProductIds;if(storedProductIds&&storedProductIds.length){var recentDataObject={"typeOfRecord":"KLEVU_PRODUCT","records":[]};klevu.each(storedProductIds,function(key,productId){recentDataObject.records.push({"id":productId});});recentObjectsList.push(recentDataObject);}
                klevu.setObjectPath(query,"settings.context.recentObjects",recentObjectsList);if(pageType==klevu.settings.constants.RECS_PT_CATEGORY){var categoryName="";if(typeof klevu_page_meta!=="undefined"&&klevu_page_meta.categoryName){categoryName=klevu.dom.helpers.convertHtmlToText(klevu_page_meta.categoryName);}
                    klevu.setObjectPath(query,"settings.query.categoryPath",categoryName);}}});}}});RECS_BOX.getScope().chains.request.build.add({name:"addNewestArrivalsQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_NEWEST_ARRIVALS){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){if(pageType==klevu.settings.constants.RECS_PT_CATEGORY){var categoryName="";if(typeof klevu_page_meta!=="undefined"&&klevu_page_meta.categoryName){categoryName=klevu.dom.helpers.convertHtmlToText(klevu_page_meta.categoryName);}
                klevu.setObjectPath(query,"settings.query.categoryPath",categoryName);}}});}}});RECS_BOX.getScope().chains.request.build.add({name:"addRecentlyViewedQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_RECENTLY_VIEWED){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){if(!data.context.storedProductIds||data.context.storedProductIds.length==0){data.context.doSearch=false;return false;}
                klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){var storedProductIds=data.context.storedProductIds;var customANDQueryStr="";var topIds=[];if(storedProductIds&&storedProductIds.length){klevu.each(storedProductIds,function(key,productId){if(key>0){customANDQueryStr+=" OR ";}
                    customANDQueryStr+='\"'+productId+'\"';topIds.push({"key":"id","value":productId});});klevu.setObjectPath(query,"settings.customANDQuery","id:("+customANDQueryStr+")");klevu.setObjectPath(query,"settings.topIds",topIds);}
                    klevu.setObjectPath(query,"settings.limit",topIds.length);if(pageType==klevu.settings.constants.RECS_PT_CATEGORY){var categoryName="";if(typeof klevu_page_meta!=="undefined"&&klevu_page_meta.categoryName){categoryName=klevu.dom.helpers.convertHtmlToText(klevu_page_meta.categoryName);}
                        klevu.setObjectPath(query,"settings.query.categoryPath",categoryName);}}});}}});RECS_BOX.getScope().chains.request.build.add({name:"addHandPickedQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.HAND_PICKED){return;}}});RECS_BOX.getScope().chains.request.build.add({name:"addOtherAlsoViewedQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_OTHER_ALSO_VIEWED){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){var recentObjectsList=[];var recentObjects=klevu.getObjectPath(query,"settings.context.recentObjects");if(recentObjects&&recentObjects.length){recentObjectsList=recentObjects;}
                var pdpProductId;var pdpProductGroupId;if(typeof klevu_page_meta!=="undefined"){if(klevu_page_meta.itemGroupId){pdpProductGroupId=klevu_page_meta.itemGroupId;}
                    if(klevu_page_meta.itemId){pdpProductId=klevu_page_meta.itemId;}}
                if(!pdpProductId){return;}
                var storedProductIds=[pdpProductId];if(storedProductIds&&storedProductIds.length){var recentDataObject={"typeOfRecord":"KLEVU_PRODUCT","records":[]};klevu.each(storedProductIds,function(key,productId){recentDataObject.records.push({"id":productId});});recentObjectsList.push(recentDataObject);}
                if(pdpProductGroupId){var excludeIds=[{"key":"itemGroupId","value":pdpProductGroupId}];var existingExcludeIds=klevu.getObjectPath(query,"settings.excludeIds",[]);if(existingExcludeIds&&existingExcludeIds.length){excludeIds=excludeIds.concat(existingExcludeIds);}
                    klevu.setObjectPath(query,"settings.excludeIds",excludeIds);}
                klevu.setObjectPath(query,"settings.context.recentObjects",recentObjectsList);}});}}});RECS_BOX.getScope().chains.request.build.add({name:"addRelatedQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_SIMILAR){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){var recentObjectsList=[];var recentObjects=klevu.getObjectPath(query,"settings.context.recentObjects");if(recentObjects&&recentObjects.length){recentObjectsList=recentObjects;}
                var pdpProductId;var pdpProductGroupId;if(typeof klevu_page_meta!=="undefined"){if(klevu_page_meta.itemGroupId){pdpProductGroupId=klevu_page_meta.itemGroupId;}
                    if(klevu_page_meta.itemId){pdpProductId=klevu_page_meta.itemId;}}
                if(!pdpProductId){return;}
                var storedProductIds=[pdpProductId];if(storedProductIds&&storedProductIds.length){var recentDataObject={"typeOfRecord":"KLEVU_PRODUCT","records":[]};klevu.each(storedProductIds,function(key,productId){recentDataObject.records.push({"id":productId});});recentObjectsList.push(recentDataObject);}
                if(pdpProductGroupId){var excludeIds=[{"key":"itemGroupId","value":pdpProductGroupId}];var existingExcludeIds=klevu.getObjectPath(query,"settings.excludeIds",[]);if(existingExcludeIds&&existingExcludeIds.length){excludeIds=excludeIds.concat(existingExcludeIds);}
                    klevu.setObjectPath(query,"settings.excludeIds",excludeIds);}
                klevu.setObjectPath(query,"settings.context.recentObjects",recentObjectsList);}});}}});RECS_BOX.getScope().chains.request.build.add({name:"addBoughtTogetherQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_BOUGHT_TOGETHER){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){var recentObjectsList=[];var recentObjects=klevu.getObjectPath(query,"settings.context.recentObjects");if(recentObjects&&recentObjects.length){recentObjectsList=recentObjects;}
                var boughtTogetherIds=[];var excludeIdsList=[];if(typeof klevu_page_meta!=="undefined"){var cartRecords=klevu_page_meta.cartRecords;if(cartRecords&&cartRecords.length){klevu.each(cartRecords,function(key,record){if(record.itemId){boughtTogetherIds.push(record.itemId);}
                    if(record.itemGroupId){excludeIdsList.push(record.itemGroupId);}});}}
                if(!boughtTogetherIds.length){return;}
                var storedProductIds=boughtTogetherIds;if(storedProductIds&&storedProductIds.length){var recentDataObject={"typeOfRecord":"KLEVU_PRODUCT","records":[]};klevu.each(storedProductIds,function(key,productId){recentDataObject.records.push({"id":productId});});recentObjectsList.push(recentDataObject);}
                if(excludeIdsList&&excludeIdsList.length>0){var excludeIds=[];klevu.each(excludeIdsList,function(key,productId){excludeIds.push({"key":"itemGroupId","value":productId});});var existingExcludeIds=klevu.getObjectPath(query,"settings.excludeIds",[]);if(existingExcludeIds&&existingExcludeIds.length){excludeIds=excludeIds.concat(existingExcludeIds);}
                    klevu.setObjectPath(query,"settings.excludeIds",excludeIds);}
                klevu.setObjectPath(query,"settings.context.recentObjects",recentObjectsList);}});}}});RECS_BOX.getScope().chains.request.build.add({name:"addBoughtTogetherPdpQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_BOUGHT_TOGETHER_PDP){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){var recentObjectsList=[];var recentObjects=klevu.getObjectPath(query,"settings.context.recentObjects");if(recentObjects&&recentObjects.length){recentObjectsList=recentObjects;}
                var pdpProductId;var pdpProductGroupId;if(typeof klevu_page_meta!=="undefined"){if(klevu_page_meta.itemGroupId){pdpProductGroupId=klevu_page_meta.itemGroupId;}
                    if(klevu_page_meta.itemId){pdpProductId=klevu_page_meta.itemId;}}
                if(!pdpProductId){return;}
                var storedProductIds=[pdpProductId];if(storedProductIds&&storedProductIds.length){var recentDataObject={"typeOfRecord":"KLEVU_PRODUCT","records":[]};klevu.each(storedProductIds,function(key,productId){recentDataObject.records.push({"id":productId});});recentObjectsList.push(recentDataObject);}
                if(pdpProductGroupId){var excludeIds=[{"key":"itemGroupId","value":pdpProductGroupId}];var existingExcludeIds=klevu.getObjectPath(query,"settings.excludeIds",[]);if(existingExcludeIds&&existingExcludeIds.length){excludeIds=excludeIds.concat(existingExcludeIds);}
                    klevu.setObjectPath(query,"settings.excludeIds",excludeIds);}
                klevu.setObjectPath(query,"settings.context.recentObjects",recentObjectsList);}});}}});RECS_BOX.getScope().chains.request.build.add({name:"addSimilarImagesQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_VISUALLY_SIMILAR){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){var sourceObjectsList=[];var sourceObjects=klevu.getObjectPath(query,"settings.context.sourceObjects");if(sourceObjects&&sourceObjects.length){sourceObjectsList=sourceObjects;}
                var pdpProductId;var pdpProductGroupId;var recentDataObject={"typeOfRecord":"KLEVU_PRODUCT","records":[]};if(typeof klevu_page_meta!=="undefined"){if(klevu_page_meta.itemGroupId){pdpProductGroupId=klevu_page_meta.itemGroupId;recentDataObject.records.push({"itemGroupId":pdpProductGroupId});}
                    if(klevu_page_meta.itemId){pdpProductId=klevu_page_meta.itemId;recentDataObject.records.push({"id":pdpProductId});}}
                if(!pdpProductId&&!pdpProductGroupId){return;}
                sourceObjectsList.push(recentDataObject);var excludeIds;if(pdpProductGroupId){excludeIds=[{"key":"itemGroupId","value":pdpProductGroupId}];var existingExcludeIds=klevu.getObjectPath(query,"settings.excludeIds",[]);if(existingExcludeIds&&existingExcludeIds.length){excludeIds=excludeIds.concat(existingExcludeIds);}
                    klevu.setObjectPath(query,"settings.excludeIds",excludeIds);}else if(pdpProductId){excludeIds=[{"key":"id","value":pdpProductId}];var existingExcludeIds=klevu.getObjectPath(query,"settings.excludeIds",[]);if(existingExcludeIds&&existingExcludeIds.length){excludeIds=excludeIds.concat(existingExcludeIds);}
                    klevu.setObjectPath(query,"settings.excludeIds",excludeIds);}
                klevu.setObjectPath(query,"settings.context.sourceObjects",sourceObjectsList);}});}}});RECS_BOX.getScope().chains.request.build.add({name:"addCustomLogicQueryOp",fire:function(data,scope){var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var logic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");if(logic!=klevu.settings.constants.RECS_LC_RECS_CUSTOM){return;}
            var recordQueries=klevu.getObjectPath(data,"request.current.recordQueries");if(recordQueries){klevu.each(recordQueries,function(key,query){if(query.id==klevu.settings.constants.RECS_QUERY_ID){if(pageType==klevu.settings.constants.RECS_PT_CATEGORY){let categoryName="";if(typeof klevu_page_meta!=="undefined"&&klevu_page_meta.categoryName){categoryName=klevu.dom.helpers.convertHtmlToText(klevu_page_meta.categoryName);}
                klevu.setObjectPath(query,"settings.query.categoryPath",categoryName);}
                if(pageType==klevu.settings.constants.RECS_PT_PRODUCT){let recentObjectsList=[];let recentObjects=klevu.getObjectPath(query,"settings.context.recentObjects");if(recentObjects&&recentObjects.length){recentObjectsList=recentObjects;}
                    let pdpProductId;let pdpProductGroupId;if(typeof klevu_page_meta!=="undefined"){if(klevu_page_meta.itemGroupId){pdpProductGroupId=klevu_page_meta.itemGroupId;}
                        if(klevu_page_meta.itemId){pdpProductId=klevu_page_meta.itemId;}}
                    if(!pdpProductId){return;}
                    let storedProductIds=[pdpProductId];if(storedProductIds&&storedProductIds.length){let recentDataObject={"typeOfRecord":"KLEVU_PRODUCT","records":[]};klevu.each(storedProductIds,function(key,productId){recentDataObject.records.push({"id":productId});});recentObjectsList.push(recentDataObject);}
                    if(pdpProductGroupId){let excludeIds=[{"key":"itemGroupId","value":pdpProductGroupId}];let existingExcludeIds=klevu.getObjectPath(query,"settings.excludeIds",[]);if(existingExcludeIds&&existingExcludeIds.length){excludeIds=excludeIds.concat(existingExcludeIds);}
                        klevu.setObjectPath(query,"settings.excludeIds",excludeIds);}
                    klevu.setObjectPath(query,"settings.context.recentObjects",recentObjectsList);}
                if(pageType==klevu.settings.constants.RECS_PT_CHECKOUT){var recentObjectsList=[];var recentObjects=klevu.getObjectPath(query,"settings.context.recentObjects");if(recentObjects&&recentObjects.length){recentObjectsList=recentObjects;}
                    var boughtTogetherIds=[];var excludeIdsList=[];if(typeof klevu_page_meta!=="undefined"){var cartRecords=klevu_page_meta.cartRecords;if(cartRecords&&cartRecords.length){klevu.each(cartRecords,function(key,record){if(record.itemId){boughtTogetherIds.push(record.itemId);}
                        if(record.itemGroupId){excludeIdsList.push(record.itemGroupId);}});}}
                    if(!boughtTogetherIds.length){return;}
                    var storedProductIds=boughtTogetherIds;if(storedProductIds&&storedProductIds.length){var recentDataObject={"typeOfRecord":"KLEVU_PRODUCT","records":[]};klevu.each(storedProductIds,function(key,productId){recentDataObject.records.push({"id":productId});});recentObjectsList.push(recentDataObject);}
                    if(excludeIdsList&&excludeIdsList.length>0){var excludeIds=[];klevu.each(excludeIdsList,function(key,productId){excludeIds.push({"key":"itemGroupId","value":productId});});var existingExcludeIds=klevu.getObjectPath(query,"settings.excludeIds",[]);if(existingExcludeIds&&existingExcludeIds.length){excludeIds=excludeIds.concat(existingExcludeIds);}
                        klevu.setObjectPath(query,"settings.excludeIds",excludeIds);}
                    klevu.setObjectPath(query,"settings.context.recentObjects",recentObjectsList);}}});}}});RECS_BOX.getScope().chains.request.build.add({name:"processRecordQueries",fire:function(data,scope){if(typeof(klevu_processRECSRecordQueries)==="function"){var recsKey=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.recsKey");klevu_processRECSRecordQueries(data.request.current.recordQueries,recsKey);}}});}});RECS_BASE.getScope().chains.search.control.add({name:"processSearchResponse",fire:function(data,scope){var RECS_BOX=scope.recsScope.searchObject;RECS_BOX.getScope().chains.template.process.success.add({name:"processCurrencySetting",fire:function(data,scope){var recsCurrencies=RECS_BOX.getScope().template.getTranslator().getCurrencyObject().getCurrencys();var productCurrency="";klevu.each(data.template.query,function(key,query){if(productCurrency==""){klevu.each(query.result,function(key,result){if(result.currency&&result.currency.length){productCurrency=result.currency;}});}});if(productCurrency.length&&!recsCurrencies[productCurrency]){recsCurrencies[productCurrency]={string:productCurrency,format:"%s %s"};var currencyLanding=RECS_BOX.getScope().template.getTranslator().getCurrencyObject();currencyLanding.setCurrencys(recsCurrencies);currencyLanding.mergeToGlobal();}}});RECS_BOX.getScope().chains.template.process.success.add({name:"populateTemplateMetadata",fire:function(data,scope){data.template.metadata=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata");}});RECS_BOX.getScope().chains.response.success.addAfter("addResponseDataQuery",{name:"processQueryResults",fire:function(data,scope){if(typeof(klevu_processRECSQueryResults)==="function"){var recsKey=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.recsKey");var queryResults=klevu.getObjectPath(data,"response.current.queryResults");klevu_processRECSQueryResults(queryResults,recsKey);}}});RECS_BOX.getScope().chains.template.process.success.add({name:"processTemplateData",fire:function(data,scope){if(typeof(klevu_processRECSTemplateData)==="function"){var recsKey=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.recsKey");klevu_processRECSTemplateData(data.template,recsKey);}}});}});RECS_BASE.getScope().chains.search.control.add({name:"renderSearchResult",fire:function(data,scope){var RECS_BOX=scope.recsScope.searchObject;RECS_BOX.getScope().chains.template.render.add({name:"renderResponse",fire:function(data,scope){if(data.context.isSuccess){var productThreshold=klevu.getObjectPath(data,"template.metadata.productThreshold");var klevuRECSItemList=klevu.getObjectPath(data,"template.query."+klevu.settings.constants.RECS_QUERY_ID+".result");if(typeof productThreshold!=="undefined"&&klevuRECSItemList&&klevuRECSItemList.length){var klevuRECSItemListLength=klevuRECSItemList.length;if(productThreshold>klevuRECSItemListLength){return;}}
            scope.kScope.template.setData(data.template);var targetBox="kuRECSTemplate";var element=scope.kScope.template.convertTemplate(scope.kScope.template.render(targetBox));var target=klevu.getSetting(scope.kScope.settings,"settings.search.searchBoxTarget");target.innerHTML='';target.classList.add("klevuTarget");scope.kScope.element.kData=data.template;scope.kScope.template.insertTemplate(target,element);}}});}});RECS_BASE.getScope().chains.search.control.add({name:"bindSearchResultElementEvents",fire:function(data,scope){var RECS_BOX=scope.recsScope.searchObject;RECS_BOX.getScope().chains.template.events.add({name:"storeResultItems",fire:function(data,scope){var apiKey=klevu.getSetting(scope.kScope.parentScope,"settings.recs.apiKey",klevu.getGlobalSetting("recs.apiKey",klevu.getGlobalSetting("global.apiKey")));var recsKey=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.recsKey");var recsTitle=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.title");var recsLogic=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.logic");var pageType=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.pageType");var spotKey=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.spotKey",false);var spotName=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.spotName",false);var segmentKey=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.segmentKey",false);var segmentName=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.segmentName",false);var recsQueryId=klevu.getGlobalSetting("constants.RECS_QUERY_ID","klevuRECSItemList");klevu.setObjectPath(scope.data,"context.section",recsQueryId);var eventTags=[];eventTags.push(klevu.settings.constants.RECS_RPT+pageType);if(klevu.isFunction(klevu.support.isActive)&&klevu.support.isActive("webhook")){let collectorPayload={type:"recommendation_view",component:"recs",scope:scope.kObject.getWebhookSettings().scope,object:scope.kObject.getWebhookSettings().object,apiKey:apiKey,user:{},data:{general:{"tags":eventTags,"list_name":recsTitle,"list_logic":recsLogic,"page_type":pageType,"recs_key":recsKey},meta:klevu.analytics.dataExtract.search.metaFromScope(scope),filters:klevu.analytics.dataExtract.search.filtersFromScope(scope),items:klevu.analytics.dataExtract.search.itemsFromScope(scope)}};if(!spotKey){klevu.setObjectPath(collectorPayload,"data.general.list_id",recsKey);}else{klevu.setObjectPath(collectorPayload,"data.general.list_id",spotKey);klevu.setObjectPath(collectorPayload,"data.general.spot_id",spotKey);}
            if(spotName)klevu.setObjectPath(collectorPayload,"data.general.spot_name",spotName);if(segmentKey)klevu.setObjectPath(collectorPayload,"data.general.segment_id",segmentKey);if(segmentName)klevu.setObjectPath(collectorPayload,"data.general.segment_name",segmentName);if(!klevu.isUndefined(klevu.user)&&klevu.user.getSessionId()){klevu.setObjectPath(collectorPayload,"user.session_id",klevu.user.getSessionId());}
            if(klevu.isFunction(klevu.support.hook)){klevu.support.hook(["analytics.collector"],function(){klevu.analytics.collector.addEvent(collectorPayload);});}
            scope.kScope.parentScope.viewPayload=collectorPayload;}else{klevu.logError("ERROR - webhook module not supported by current core version, please upgrade klevu core to latest version");}}});RECS_BOX.getScope().chains.template.events.add({name:"storeResultItemsClick",fire:function(data,scope){var target=klevu.getSetting(scope.kScope.settings,"settings.search.searchBoxTarget");var kuRECSItemClick=klevu.dom.find(".kuRECSItemClick",target);if(kuRECSItemClick){klevu.each(kuRECSItemClick,function(key,element){klevu.event.attach(element,"click",function(e){var parentRECSElem=klevu.dom.helpers.getClosest(element,".klevuTarget");var recsKey=klevu.getObjectPath(parentRECSElem.recsScope,"kmcData.metadata.recsKey");var itemId=(element.dataset&&element.dataset.id&&element.dataset.id!="")?element.dataset.id:"";var topElement=klevu.dom.helpers.getClosest(element,".kuRECSItem,.kcResultItem");var topItemId=(topElement.dataset&&topElement.dataset.id&&topElement.dataset.id!="")?topElement.dataset.id:"";if((itemId!=""||topItemId!="")&&recsKey){if(itemId=="")itemId=topItemId;klevu.dom.helpers.addClickedProductToCookie(itemId);let viewPayload=klevu.getObjectPath(parentRECSElem.recsScope,"viewPayload",false);if(viewPayload){let items=klevu.getObjectPath(viewPayload,"data.items",[]);if(items.length>0){klevu.each(items,function(key,impression){if(impression.id==itemId){let clickedItems=[impression];klevu.setObjectPath(viewPayload,"type","recommendation_click");klevu.setObjectPath(viewPayload,"data.items",clickedItems);if(klevu.isFunction(klevu.support.hook)){klevu.support.hook(["analytics.collector"],function(){klevu.analytics.collector.addEvent(viewPayload);});}}});}}}});});}}});RECS_BOX.getScope().chains.template.events.add({name:"attachObserverFunctionForItemClick",fire:function(data,scope){var target=klevu.getSetting(scope.kScope.settings,"settings.search.searchBoxTarget");var kuRECSItemClick=klevu.dom.find(".kuRECSItemClick",target);if(kuRECSItemClick){klevu.each(kuRECSItemClick,function(key,element){klevu.event.attach(element,"click",function(e){if(typeof(klevu_RECSItemClick)==="function"){var parentRECSElem=klevu.dom.helpers.getClosest(element,".klevuTarget");var recsKey=klevu.getObjectPath(parentRECSElem.recsScope,"kmcData.metadata.recsKey");var itemId=(element.dataset&&element.dataset.id&&element.dataset.id!="")?element.dataset.id:"";var topElement=klevu.dom.helpers.getClosest(element,".kuRECSItem,.kcResultItem");var topItemId=(topElement.dataset&&topElement.dataset.id&&topElement.dataset.id!="")?topElement.dataset.id:"";if((itemId!=""||topItemId!="")&&recsKey){if(itemId=="")itemId=topItemId;}
            klevu_RECSItemClick(data.template,itemId,recsKey);}});});}}});RECS_BOX.getScope().chains.template.events.add({name:"bindTemplateElementEvents",fire:function(data,scope){if(typeof(klevu_bindRECSTemplateElementEvents)==="function"){var recsKey=klevu.getObjectPath(scope.kScope.parentScope,"kmcData.metadata.recsKey");klevu_bindRECSTemplateElementEvents(data.template,recsKey);}}});}});RECS_BASE.getScope().chains.search.control.add({name:"addScriptEvaluation",fire:function(data,scope){var script=klevu.getObjectPath(scope.recsScope,"kmcData.scripts.recsObject");if(!klevu.isUndefined(script)&&script!==""){var randomFunctionName=klevu.randomFunctionName();klevu.globalEval("function "+randomFunctionName+"(data,scope){"+script+"}");klevu.executeFunctionByName(randomFunctionName,window,data,scope);}}});RECS_BASE.getScope().chains.search.control.add({name:"setSearchBoxTarget",fire:function(data,scope){var RECS_BOX=scope.recsScope.searchObject;RECS_BOX.setTarget(scope.recsScope.element);}});RECS_BASE.getScope().chains.search.control.add({name:"addWebhookBuild",fire:function(data,scope){if(klevu.isFunction(klevu.support.isActive)&&klevu.support.isActive("webhook")){var RECS_BOX=scope.recsScope.searchObject;var webhookSettings=klevu.extend(true,{},RECS_BOX.getWebhookSettings());webhookSettings.name="mainObject";webhookSettings.action="build";klevu.event.webhook.runForScopeList({data:RECS_BOX.getScope().data,scope:RECS_BOX.getScope().element,settings:webhookSettings});}else{klevu.logError("ERROR - webhook module not supported by current core version, please upgrade klevu core to latest version");}}});RECS_BASE.getScope().chains.search.control.add({name:"powerUpRECSSearchObject",fire:function(data,scope){var RECS_BOX=scope.recsScope.searchObject;var tempElement=RECS_BOX.getScope().element;tempElement.value="*";tempElement.kScope.data=tempElement.kObject.resetData(tempElement);if(klevu.isFunction(klevu.support.isActive)&&klevu.support.isActive("webhook")){var webhookSettings=klevu.extend(true,{},RECS_BOX.getWebhookSettings());webhookSettings.name="mainObject";webhookSettings.action="beforeInit";klevu.event.webhook.runForScopeList({data:RECS_BOX.getScope().data,scope:RECS_BOX.getScope().element,settings:webhookSettings});}else{klevu.logError("ERROR - webhook module not supported by current core version, please upgrade klevu core to latest version");}
        klevu.event.fireChain(tempElement.kScope,"chains.events.keyUp",tempElement,tempElement.kScope.data,null);if(klevu.isFunction(klevu.support.isActive)&&klevu.support.isActive("webhook")){var webhookSettings=klevu.extend(true,{},RECS_BOX.getWebhookSettings());webhookSettings.name="mainObject";webhookSettings.action="afterInit";klevu.event.webhook.runForScopeList({data:RECS_BOX.getScope().data,scope:RECS_BOX.getScope().element,settings:webhookSettings});}else{klevu.logError("ERROR - webhook module not supported by current core version, please upgrade klevu core to latest version");}}});RECS_BASE.getScope().chains.type.hideBanner.add({name:"checkHideBanner",fire:function(data,scope){var recsKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.recsKey");var action=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.action",false);if(action==="HIDE_RECOMMENDATION"){console.info("RECS element is hidden");return false;}}});RECS_BASE.getScope().chains.type.staticContent.add({name:"validateRECSElementData",fire:function(data,scope){var recsKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.recsKey");if(!recsKey){console.info("RECS element id is missing.");return false;}
        var isEnabled=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.enabled");if(!isEnabled){console.info("["+recsKey+"] element is disabled.");return false;}
        var hasAnyError=false;var logic=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.logic");if(!logic){console.info("["+recsKey+"] RECS logic is missing.");hasAnyError=true;}
        var pageType=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.pageType");if(!pageType){console.info("["+recsKey+"] RECS page type is missing.");hasAnyError=true;}
        if(hasAnyError){return false;}}});RECS_BASE.getScope().chains.type.staticContent.add({name:"addElementStylesToHead",fire:function(data,scope){var recsKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.recsKey");var elementStyles=klevu.getObjectPath(scope.recsScope,"kmcData.styles.base");if(recsKey){klevu.each(klevu.dom.find("#ku-recs-"+recsKey),function(key,existingElement){if(existingElement&&existingElement.parentNode){existingElement.parentNode.removeChild(existingElement);}});}
        klevu.dom.helpers.addElementToHead({content:elementStyles,type:"css",name:"ku-recs-"+recsKey});}});RECS_BASE.getScope().chains.type.staticContent.add({name:"registerRECSTemplate",fire:function(data,scope){var RECS_TEMPLATE_OBJ=klevu.template();scope.recsScope.template=RECS_TEMPLATE_OBJ;var templateString=klevu.getObjectPath(scope.recsScope,"kmcData.templates.base");RECS_TEMPLATE_OBJ.setTemplate(templateString,"kuRECSTemplate",true);}});RECS_BASE.getScope().chains.type.staticContent.add({name:"addScriptEvaluation",fire:function(data,scope){var script=klevu.getObjectPath(scope.recsScope,"kmcData.scripts.recsObject");if(!klevu.isUndefined(script)&&script!==""){var randomFunctionName=klevu.randomFunctionName();klevu.globalEval("function "+randomFunctionName+"(data,scope){"+script+"}");klevu.executeFunctionByName(randomFunctionName,window,data,scope);}}});RECS_BASE.getScope().chains.type.staticContent.add({name:"renderStaticContent",fire:function(data,scope){var RECS_TEMPLATE_OBJ=scope.recsScope.template;var action=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.action");if(action==='STATIC_CONTENT'){if(data.context.isSuccess){RECS_TEMPLATE_OBJ.setData(data.scope.recsScope.kmcData);var targetBox="kuRECSTemplate";var element=RECS_TEMPLATE_OBJ.convertTemplate(RECS_TEMPLATE_OBJ.render(targetBox));var target=scope.recsScope.element;target.innerHTML='';target.classList.add("klevuTarget");RECS_TEMPLATE_OBJ.insertTemplate(target,element);}}}});RECS_BASE.getScope().chains.type.staticContent.add({name:"staticContentAnalyticsView",fire:function(data,scope){var action=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.action");var recsKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.recsKey");var apiKey=klevu.getSetting(scope.recsScope,"settings.recs.apiKey",klevu.getGlobalSetting("recs.apiKey",klevu.getGlobalSetting("global.apiKey")));var recsTitle=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.title");var recsLogic=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.logic");var pageType=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.pageType");var spotKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.spotKey",false);var spotName=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.spotName",false);var segmentKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.segmentKey",false);var segmentName=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.segmentName",false);var staticContent=klevu.getObjectPath(scope.recsScope,"kmcData.staticContent",false);let target=scope.recsScope.element;if(!target){return;}
        let allVisibleContent=klevu.dom.find('[data-view="banner"]',target);let activeStaticContent=[];if(allVisibleContent.length){klevu.each(allVisibleContent,function(key,value){let content={"static_item_id":value.getAttribute("data-id")||'',"content_type":value.getAttribute("data-type")||'',"resolution":value.getAttribute("data-resolution")||'',"banner_image_url":value.querySelector("img")?.getAttribute("src")||'',"banner_alt_tag":value.querySelector("img")?.getAttribute("alt")||'',"index":(key+1)};activeStaticContent.push(content);});}
        var eventTags=[];eventTags.push(klevu.getGlobalSetting("constants.RECS_RPT","")+pageType);if(action==='STATIC_CONTENT'&&klevu.isFunction(klevu.support.hook)){let collectorPayload={type:"recommendation_view_static",component:"recs",apiKey:apiKey,user:{},data:{general:{"tags":eventTags,"list_name":recsTitle,"list_logic":recsLogic,"page_type":pageType,"recs_key":recsKey,"spot_id":spotKey,"spot_name":spotName},staticContent:staticContent,activeStaticContent:activeStaticContent}};if(!spotKey){klevu.setObjectPath(collectorPayload,"data.general.list_id",recsKey);}else{klevu.setObjectPath(collectorPayload,"data.general.list_id",spotKey);klevu.setObjectPath(collectorPayload,"data.general.spot_id",spotKey);}!!spotName&&klevu.setObjectPath(collectorPayload,"data.general.spot_name",spotName);!!segmentKey&&klevu.setObjectPath(collectorPayload,"data.general.segment_id",segmentKey);!!segmentName&&klevu.setObjectPath(collectorPayload,"data.general.segment_name",segmentName);!!action&&klevu.setObjectPath(collectorPayload,"data.general.action",action);if(!klevu.isUndefined(klevu.user)&&klevu.user.getSessionId()){klevu.setObjectPath(collectorPayload,"user.session_id",klevu.user.getSessionId());}
            klevu.support.hook(["analytics.collector"],function(){klevu.analytics.collector.addEvent(collectorPayload);});}}});RECS_BASE.getScope().chains.type.staticContent.add({name:"staticContentAnalyticsClick",fire:function(data,scope){var action=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.action");var recsKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.recsKey");var apiKey=klevu.getSetting(scope.recsScope,"settings.recs.apiKey",klevu.getGlobalSetting("recs.apiKey",klevu.getGlobalSetting("global.apiKey")));var recsTitle=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.title");var recsLogic=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.logic");var pageType=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.pageType");var spotKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.spotKey",false);var spotName=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.spotName",false);var segmentKey=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.segmentKey",false);var segmentName=klevu.getObjectPath(scope.recsScope,"kmcData.metadata.segmentName",false);var staticContent=klevu.getObjectPath(scope.recsScope,"kmcData.staticContent",false);var eventTags=[];eventTags.push(klevu.getGlobalSetting("constants.RECS_RPT","")+pageType);if(action==='STATIC_CONTENT'){let collectorPayload={type:"recommendation_click_static",component:"recs",apiKey:apiKey,user:{},data:{general:{"tags":eventTags,"list_name":recsTitle,"list_logic":recsLogic,"page_type":pageType,"recs_key":recsKey,"spot_id":spotKey,"spot_name":spotName},staticContent:staticContent}};if(!spotKey){klevu.setObjectPath(collectorPayload,"data.general.list_id",recsKey);}else{klevu.setObjectPath(collectorPayload,"data.general.list_id",spotKey);klevu.setObjectPath(collectorPayload,"data.general.spot_id",spotKey);}!!spotName&&klevu.setObjectPath(collectorPayload,"data.general.spot_name",spotName);!!segmentKey&&klevu.setObjectPath(collectorPayload,"data.general.segment_id",segmentKey);!!segmentName&&klevu.setObjectPath(collectorPayload,"data.general.segment_name",segmentName);!!action&&klevu.setObjectPath(collectorPayload,"data.general.action",action);if(!klevu.isUndefined(klevu.user)&&klevu.user.getSessionId()){klevu.setObjectPath(collectorPayload,"user.session_id",klevu.user.getSessionId());}
        let target=scope.recsScope.element;let kuRECSItemClick=klevu.dom.find(".kuRECSItemClick",target);if(kuRECSItemClick&&klevu.isFunction(klevu.support.hook)){klevu.each(kuRECSItemClick,function(key,element){klevu.event.attach(element,"click",function(e){let parentTarget=klevu.dom.helpers.getClosest(e.target,".kuRECSItemClick");let content={"static_item_id":parentTarget.getAttribute("data-id")||'',"content_type":parentTarget.getAttribute("data-type")||'',"resolution":parentTarget.getAttribute("data-resolution")||'',"banner_image_url":parentTarget.querySelector("img")?.getAttribute("src")||'',"banner_alt_tag":parentTarget.querySelector("img")?.getAttribute("alt")||'',"index":(key+1)};klevu.setObjectPath(collectorPayload,"data.staticContent",[content]);klevu.support.hook(["analytics.collector"],function(){klevu.analytics.collector.addEvent(collectorPayload);});});});}}}});}})(klevu);klevu.coreEvent.build({name:"setRemoteConfigRecsBaseUpdates",fire:function(){if(klevu.isUndefined(klevu.recs)||klevu.isUndefined(klevu.recs.base)){return false;}
        return true;},maxCount:500,delay:30});klevu.coreEvent.build({name:"setRemoteConfigRecs",fire:function(){if(klevu.isUndefined(klevu.recs)||!klevu.getGlobalSetting("recs.apiKey",klevu.getGlobalSetting("global.apiKey",false))||!klevu.dom.find(".klevu-recs").length||!klevu.getSetting(klevu.settings,"settings.powerUp.recsModule")){return false;}
        return true;},maxCount:50,delay:300});klevu.coreEvent.attach("setRemoteConfigRecsBaseUpdates",{name:"klevuRECSCustomization",fire:function(){klevu.recs.base.getScope().chains.search.control.add({name:"attachCustomEvents",fire:function(data,scope){var parentScope=scope.recsScope;scope.recsScope.searchObject.getScope().chains.template.events.add({name:"bindAddToCartButtonEvent",fire:function(data,scope){var target=klevu.getSetting(scope.kScope.settings,"settings.search.searchBoxTarget");var kuRECSAddToCart=klevu.dom.find(".kuRECSAddToCartBtn",target);if(kuRECSAddToCart){klevu.each(kuRECSAddToCart,function(key,element){klevu.event.attach(element,"click",function(){var variantId=(element.dataset&&element.dataset.id)?element.dataset.id:"";var productURL=(element.dataset&&element.dataset.url)?element.dataset.url:"";var quantity=(element.dataset&&element.dataset.qty)?element.dataset.qty:0;if(typeof(klevu_addtocart)==="function"){var recsKey=klevu.getObjectPath(parentScope,"kmcData.metadata.recsKey");klevu_addtocart(variantId,productURL,quantity,recsKey);}});});}}});scope.recsScope.searchObject.getScope().chains.template.events.add({name:"bindAddToCartButtonAnalytics",fire:function(data,scope){var target=klevu.getSetting(scope.kScope.settings,"settings.search.searchBoxTarget");var kuRECSAddToCart=klevu.dom.find(".kuRECSAddToCartBtn",target);if(kuRECSAddToCart){klevu.each(kuRECSAddToCart,function(key,element){klevu.event.attach(element,"click",function(){var parentRECSElem=klevu.dom.helpers.getClosest(element,".klevuTarget");var recsKey=klevu.getObjectPath(parentRECSElem.recsScope,"kmcData.metadata.recsKey");var itemId=(element.dataset&&element.dataset.id&&element.dataset.id!="")?element.dataset.id:"";var topElement=klevu.dom.helpers.getClosest(element,".kuRECSItem,.kcResultItem");var topItemId=(topElement.dataset&&topElement.dataset.id&&topElement.dataset.id!="")?topElement.dataset.id:"";if((itemId!=""||topItemId!="")&&recsKey){if(itemId=="")itemId=topItemId;klevu.dom.helpers.addClickedProductToCookie(itemId);let viewPayload=klevu.getObjectPath(parentRECSElem.recsScope,"viewPayload",false);if(viewPayload){let items=klevu.getObjectPath(viewPayload,"data.items",[]);if(items.length>0){klevu.each(items,function(key,impression){if(impression.id==itemId){let clickedItems=[impression];klevu.setObjectPath(viewPayload,"type","recommendation_click");klevu.setObjectPath(viewPayload,"data.items",clickedItems);if(klevu.isFunction(klevu.support.hook)){klevu.support.hook(["analytics.collector"],function(){klevu.analytics.collector.addEvent(viewPayload);});}}});}}}});});}}});}});}});klevu.coreEvent.attach("setRemoteConfigRecs",{name:"populateRECSObjectClone",fire:function(){klevu.each(klevu.dom.find(".klevu-recs"),function(key,recsTargetElement){if(!recsTargetElement.id){console.info("No Klevu RECS ID found on the targeted element!",recsTargetElement);return;}
        klevu.recs.clone({recId:recsTargetElement.id,apiKey:klevu.getGlobalSetting("recs.apiKey",klevu.getGlobalSetting("global.apiKey")),element:recsTargetElement});});}});klevu.coreEvent.attach("setRemoteConfigRecs",{name:"powerUpRECSList",fire:function(){var recsList=klevu.recs.list;if(recsList&&recsList.length){klevu.each(recsList,function(key,recsObj){recsObj.powerUp();});}}});
